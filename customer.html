<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>License Portal ‚Äî ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤ (‡∏≠‡πà‡∏≤‡∏ô‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß)</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<link href="https://fonts.googleapis.com/css2?family=Prompt:wght@400;600;700&display=swap" rel="stylesheet">
<style>
  :root{
    --bg:#0f172a;--card:#1f2937;--text:#e5e7eb;--muted:#94a3b8;--accent:#22d3ee;
    --ok:#10b981;--warn:#f59e0b;--err:#ef4444;--border:#374151
  }
  *{box-sizing:border-box}
  body{margin:0;background:var(--bg);color:var(--text);font-family:'Prompt',system-ui}
  .wrap{max-width:1100px;margin:32px auto;padding:0 16px}
  h1{margin:0 0 8px}
  .card{background:var(--card);border:1px solid var(--border);border-radius:16px;padding:16px}
  .muted{color:var(--muted)}
  .grid{display:grid;gap:12px}
  .toolbar{display:flex;gap:8px;flex-wrap:wrap;align-items:end}
  input,select{padding:10px 12px;border-radius:12px;border:1px solid var(--border);background:#111827;color:var(--text)}
  .tag{padding:4px 8px;border:1px solid var(--border);border-radius:999px;font-size:12px;color:var(--muted)}
  .badge{padding:4px 10px;border-radius:999px;font-size:12px;font-weight:700;display:inline-block}
  .b-active{background:rgba(16,185,129,.15);color:#34d399}
  .b-expiring{background:rgba(245,158,11,.15);color:#fbbf24}
  .b-expired{background:rgba(239,68,68,.15);color:#f87171}
  .b-renewed{background:rgba(96,165,250,.15);color:#93c5fd}
  .items{border-left:2px solid var(--border);margin-left:6px;padding-left:12px}
  .line{padding:6px 0;border-bottom:1px dashed var(--border)}
  .btn{padding:10px 14px;border-radius:12px;border:1px solid var(--border);background:#0b1220;color:var(--text);cursor:pointer}
  .btn:hover{opacity:.9}
  .btn-accent{background:var(--accent);color:#0b1220;border:none;font-weight:700}
  .btn-line{background:#06c755;color:#fff;border:none;font-weight:700}
  .btn-line:hover{opacity:.9}
</style>
</head>
<body>
<div class="wrap">
  <h1>‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏ö‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡∏Ç‡∏≠‡∏á‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó‡∏Ñ‡∏∏‡∏ì</h1>
  <p class="muted" id="companyInfo">‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...</p>

  <!-- ‡πÅ‡∏ñ‡∏ö‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤/‡∏Å‡∏£‡∏≠‡∏á -->
  <div class="card" style="margin-top:12px">
    <div class="toolbar">
      <div>
        <label class="muted">‡∏Ñ‡πâ‡∏ô‡∏´‡∏≤</label><br/>
        <input id="searchText" placeholder="‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏≤/‡∏™‡∏≤‡∏°‡∏±‡∏ç/‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô/‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï"/>
      </div>
      <div>
        <label class="muted">‡πÉ‡∏Å‡∏•‡πâ‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏‡πÉ‡∏ô (‡∏ß‡∏±‡∏ô)</label><br/>
        <select id="expSoon">
          <option value="">‚Äî ‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î ‚Äî</option>
          <option value="30">‚â§ 30 ‡∏ß‡∏±‡∏ô</option>
          <option value="60">‚â§ 60 ‡∏ß‡∏±‡∏ô</option>
          <option value="90">‚â§ 90 ‡∏ß‡∏±‡∏ô</option>
        </select>
      </div>
      <div>
        <label class="muted">‡∏ä‡πà‡∏ß‡∏á‡∏ß‡∏±‡∏ô‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏</label><br/>
        <input id="validToFrom" type="date" style="width:170px"/>
        <input id="validToTo" type="date" style="width:170px"/>
      </div>
      <div style="margin-left:auto;display:flex;gap:8px">
        <button class="btn" id="btnRefresh">‡∏£‡∏µ‡πÄ‡∏ü‡∏£‡∏ä</button>
        <button class="btn btn-accent" id="btnCopyContact">‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏Å‡∏•‡∏±‡∏ö</button>
      </div>
    </div>
  </div>

  <!-- ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£ -->
  <div class="card" style="margin-top:12px">
    <h3 style="margin:0 0 8px">‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡πÉ‡∏ö‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï</h3>
    <div id="listArea" class="grid"></div>
  </div>

  <p class="muted" style="margin-top:12px">‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏î‡πà‡∏ß‡∏ô LINE OA: <b>@991cyisb</b></p>
</div>

<script>
  const SUPABASE_URL = "https://velbtupsfspvfqhytaci.supabase.co";
  const SUPABASE_ANON_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InZlbGJ0dXBzZnNwdmZxaHl0YWNpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTkxNDYyMjQsImV4cCI6MjA3NDcyMjIyNH0.ZVGvKh1ytyKUFH4b8T4ItVPXpFPSI57DXhuy89uVxKk";
  const sb = window.supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
  const OA_HANDLE = "@991cyisb";
  const OA_URL = "https://line.me/R/ti/p/@991cyisb";

  const params = new URLSearchParams(location.search);
  const COMPANY_CODE = (params.get('company')||'').trim();

  const companyInfo = document.getElementById('companyInfo');
  const listArea = document.getElementById('listArea');
  const searchText = document.getElementById('searchText');
  const expSoon = document.getElementById('expSoon');
  const validToFrom = document.getElementById('validToFrom');
  const validToTo = document.getElementById('validToTo');
  const btnRefresh = document.getElementById('btnRefresh');
  const btnCopyContact = document.getElementById('btnCopyContact');

  function badgeClass(s){return({active:'b-active',expiring:'b-expiring',expired:'b-expired',renewed:'b-renewed'}[s]||'');}
  function daysLeft(to){if(!to)return null;const t=new Date();t.setHours(0,0,0,0);const d=new Date(to);if(isNaN(d))return null;d.setHours(0,0,0,0);return Math.floor((d-t)/(1000*60*60*24));}
  function derivedStatus(rec){const d=daysLeft(rec.valid_to);if(d===null)return rec.status||'active';if(d<0)return'expired';if(d<=30)return'expiring';return rec.status||'active';}
  function thaiDate(str){if(!str)return'-';const d=new Date(str+'T00:00:00');if(isNaN(d))return str;return d.toLocaleDateString('th-TH',{year:'numeric',month:'short',day:'numeric'});}
  async function copy(text){try{await navigator.clipboard.writeText(text);alert('‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß');}catch{const ta=document.createElement('textarea');ta.value=text;document.body.appendChild(ta);ta.select();document.execCommand('copy');ta.remove();alert('‡∏Ñ‡∏±‡∏î‡∏•‡∏≠‡∏Å‡πÅ‡∏•‡πâ‡∏ß');}}

  let company=null,licenses=[],items=[];
  async function loadData(){
    if(!COMPANY_CODE){companyInfo.innerHTML='‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡πÄ‡∏õ‡∏¥‡∏î‡∏ú‡πà‡∏≤‡∏ô <b>index.html</b> ‡∏´‡∏£‡∏∑‡∏≠‡πÉ‡∏™‡πà‡∏û‡∏≤‡∏£‡∏≤‡∏°‡∏¥‡πÄ‡∏ï‡∏≠‡∏£‡πå <span class="tag">?company=‡∏£‡∏´‡∏±‡∏™‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó</span>';return;}
    companyInfo.textContent='‡∏Å‡∏≥‡∏•‡∏±‡∏á‡πÇ‡∏´‡∏•‡∏î...';
    const [{data:comps},{data:lic},{data:its}] = await Promise.all([
      sb.from('companies').select('*').eq('code',COMPANY_CODE).maybeSingle(),
      sb.from('licenses').select('*').eq('company_code',COMPANY_CODE),
      sb.from('license_items').select('*')
    ]);
    company=comps;licenses=lic||[];items=its||[];
    if(!company){companyInfo.innerHTML=`‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó <b>${COMPANY_CODE}</b>`;return;}
    companyInfo.innerHTML=`<b>${company.name}</b> <span class="muted">(${company.code})</span> ‚Äî ‡∏•‡∏π‡∏Å‡∏Ñ‡πâ‡∏≤‡∏≠‡πà‡∏≤‡∏ô‡∏≠‡∏¢‡πà‡∏≤‡∏á‡πÄ‡∏î‡∏µ‡∏¢‡∏ß`;
    render();
  }

  function render(){
    const itemsByLic={};for(const it of items)(itemsByLic[it.license_id] ||= []).push(it);
    let rows=licenses.map(l=>({...l,_items:itemsByLic[l.id]||[],_status:derivedStatus(l)}));
    const q=(searchText.value||'').trim().toLowerCase();
    if(q){rows=rows.filter(r=>{const me=`${r.license_no} ${r.note||''}`.toLowerCase();const itm=r._items.map(it=>`${it.trade_name||''} ${it.common_name||''} ${it.registration_no||''}`).join(' ').toLowerCase();return me.includes(q)||itm.includes(q);});}
    if(expSoon.value){const limit=parseInt(expSoon.value,10);rows=rows.filter(r=>{const d=daysLeft(r.valid_to);return d!==null&&d>=0&&d<=limit&&r._status!=='renewed';});}
    if(validToFrom.value)rows=rows.filter(r=>r.valid_to&&r.valid_to>=validToFrom.value);
    if(validToTo.value)rows=rows.filter(r=>r.valid_to&&r.valid_to<=validToTo.value);

    listArea.innerHTML='';
    if(rows.length===0){listArea.innerHTML='<span class="muted">‚Äî ‡πÑ‡∏°‡πà‡∏û‡∏ö‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ï‡∏≤‡∏°‡πÄ‡∏á‡∏∑‡πà‡∏≠‡∏ô‡πÑ‡∏Ç ‚Äî</span>';return;}

    for(const lic of rows){
      const box=document.createElement('div');box.className='items';
      const dleft=daysLeft(lic.valid_to);
      const dtext=dleft==null?'':`<span class="tag">D-${dleft>=0?dleft:('+'+Math.abs(dleft))}</span>`;
      const hint=(()=>{
        if(dleft==null)return'';
        if(dleft<0)return`<span class="badge b-expired">‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏‡∏°‡∏≤‡∏ô‡∏≤‡∏ô ${Math.abs(dleft)} ‡∏ß‡∏±‡∏ô</span>`;
        if(dleft===0)return`<span class="badge b-expiring">‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏‡∏ß‡∏±‡∏ô‡∏ô‡∏µ‡πâ</span>`;
        if(dleft<=30&&lic._status!=='renewed')return`<span class="badge b-expiring">‡πÉ‡∏Å‡∏•‡πâ‡∏´‡∏°‡∏î‡∏≠‡∏≤‡∏¢‡∏∏‡πÉ‡∏ô ${dleft} ‡∏ß‡∏±‡∏ô</span>`;
        return'';
      })();

      box.innerHTML=`
        <div class="line">
          <b>‡∏ä‡∏∑‡πà‡∏≠‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó:</b> ${company.name} <span class="muted">(${company.code})</span><br>
          <b>‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà‡πÉ‡∏ö‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï:</b> ${lic.license_no}
          <span class="badge ${badgeClass(lic._status)}">${lic._status}</span>
          ${dtext} ${hint}
          ${lic.valid_from?`<span class="tag">‡∏ï‡∏±‡πâ‡∏á‡πÅ‡∏ï‡πà ${lic.valid_from}</span>`:''}
          ${lic.valid_to?`<span class="tag">‡∏ñ‡∏∂‡∏á ${lic.valid_to}</span>`:''}
          ${lic.renewed_at?`<div class="muted">‡∏ï‡πà‡∏≠‡∏Ñ‡∏£‡∏±‡πâ‡∏á‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î: <b>${lic.renewed_at}</b></div>`:''}
          ${lic.note?`<div class="muted">‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏: ${lic.note}</div>`:''}
          ${lic.status_note?`<div class="muted" style="margin-top:8px"><b>üìå ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏‡πÄ‡∏û‡∏¥‡πà‡∏°‡πÄ‡∏ï‡∏¥‡∏°‡∏à‡∏≤‡∏Å‡∏ú‡∏π‡πâ‡∏î‡∏π‡πÅ‡∏•:</b> ${lic.status_note}</div>`:''}
          <button class="btn btn-line" style="margin-top:8px" onclick="window.open('${OA_URL}?text=‡∏™‡∏ß‡∏±‡∏™‡∏î‡∏µ‡∏Ñ‡πà‡∏∞ ‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó ${company.name} (${company.code}) ‡πÉ‡∏ö‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà ${lic.license_no}', '_blank')">
            üí¨ ‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏ó‡∏≤‡∏á LINE
          </button>
        </div>
      `;

      if(lic._items.length===0){
        const none=document.createElement('div');none.className='muted';none.style.padding='6px 0';none.textContent='‚Äî ‡∏¢‡∏±‡∏á‡πÑ‡∏°‡πà‡∏°‡∏µ‡∏£‡∏≤‡∏¢‡∏Å‡∏≤‡∏£‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏≤/‡∏™‡∏≤‡∏°‡∏±‡∏ç/‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà ‚Äî';box.appendChild(none);
      }else{
        for(const it of lic._items){
          const line=document.createElement('div');line.style.padding='6px 0';
          line.innerHTML=`
            <div>
              <span class="tag"><b>‡∏ä‡∏∑‡πà‡∏≠‡∏Å‡∏≤‡∏£‡∏Ñ‡πâ‡∏≤</b>: ${it.trade_name||'-'}</span>
              <span class="tag"><b>‡∏ä‡∏∑‡πà‡∏≠‡∏™‡∏≤‡∏°‡∏±‡∏ç</b>: ${it.common_name||'-'}</span>
              <span class="tag"><b>‡∏ó‡∏∞‡πÄ‡∏ö‡∏µ‡∏¢‡∏ô‡πÄ‡∏•‡∏Ç‡∏ó‡∏µ‡πà</b>: ${it.registration_no||'-'}</span>
            </div>`;
          box.appendChild(line);
        }
      }
      listArea.appendChild(box);
    }
  }

  btnCopyContact.addEventListener('click',()=>{
    const msg=[
      `‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏ó‡∏µ‡∏°‡∏á‡∏≤‡∏ô`,
      company?`‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó: ${company.name} (${company.code})`:`‡∏ö‡∏£‡∏¥‡∏©‡∏±‡∏ó: -`,
      `‡∏Ç‡∏≠‡∏™‡∏≠‡∏ö‡∏ñ‡∏≤‡∏°/‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡∏ï‡πà‡∏≠‡∏≠‡∏≤‡∏¢‡∏∏‡πÉ‡∏ö‡∏≠‡∏ô‡∏∏‡∏ç‡∏≤‡∏ï`,
      ``,
      `‡∏ï‡∏¥‡∏î‡∏ï‡πà‡∏≠‡∏Å‡∏•‡∏±‡∏ö‡∏ó‡∏≤‡∏á LINE OA: ${OA_HANDLE}`
    ].join('\n');
    copy(msg);
  });

  btnRefresh.addEventListener('click',loadData);
  searchText.addEventListener('input',render);
  expSoon.addEventListener('change',render);
  validToFrom.addEventListener('change',render);
  validToTo.addEventListener('change',render);
  loadData();
</script>
</body>
</html>
